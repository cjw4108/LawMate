<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lawmate.dao.DocumentDAO">

    <resultMap id="categoryResultMap" type="com.lawmate.dto.DocumentCategoryDTO">
        <id property="id" column="ID"/>
        <result property="name" column="NAME"/>
        <result property="description" column="DESCRIPTION"/>
        <result property="parentId" column="PARENT_ID"/>
        <result property="displayOrder" column="DISPLAY_ORDER"/>
        <result property="isActive" column="IS_ACTIVE"/>
        <result property="createdAt" column="CREATED_AT"/>
    </resultMap>

    <resultMap id="documentResultMap" type="com.lawmate.dto.DocumentDTO">
        <id property="id" column="ID"/>
        <result property="categoryId" column="CATEGORY_ID"/>
        <result property="title" column="TITLE"/>
        <result property="description" column="DESCRIPTION"/>
        <result property="filePath" column="FILE_PATH"/>
        <result property="templateHtml" column="TEMPLATE_HTML"/>
        <result property="fileSize" column="FILE_SIZE"/>
        <result property="fileType" column="FILE_TYPE"/>
        <result property="accessType" column="ACCESS_TYPE"/>
        <result property="downloadCount" column="DOWNLOAD_COUNT"/>
        <result property="isActive" column="IS_ACTIVE"/>
        <result property="userId" column="USER_ID"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="categoryName" column="CATEGORY_NAME"/>
    </resultMap>


    <insert id="insertCategory" parameterType="com.lawmate.dto.DocumentCategoryDTO">
        INSERT INTO DOCUMENT_CATEGORIES (
            NAME, DESCRIPTION, PARENT_ID, DISPLAY_ORDER, IS_ACTIVE, CREATED_AT
        ) VALUES (
                     #{name}, #{description}, #{parentId, jdbcType=NUMERIC}, #{displayOrder}, #{isActive}, SYSDATE
                 )
    </insert>

    <select id="selectAllCategories" resultMap="categoryResultMap">
        SELECT * FROM DOCUMENT_CATEGORIES ORDER BY DISPLAY_ORDER
    </select>

    <select id="selectCategoryById" parameterType="long" resultMap="categoryResultMap">
        SELECT * FROM DOCUMENT_CATEGORIES WHERE ID = #{id}
    </select>

    <select id="selectCategoryByName" parameterType="string" resultMap="categoryResultMap">
        SELECT * FROM DOCUMENT_CATEGORIES WHERE NAME = #{name}
    </select>


    <insert id="insertDocument" parameterType="com.lawmate.dto.DocumentDTO">
        INSERT INTO DOCUMENTS (
            CATEGORY_ID, TITLE, DESCRIPTION, FILE_PATH, FILE_TYPE,
            ACCESS_TYPE, DOWNLOAD_COUNT, IS_ACTIVE, CREATED_AT
        ) VALUES (
                     #{categoryId}, #{title}, #{description}, #{filePath}, #{fileType},
                     #{accessType}, #{downloadCount}, #{isActive}, SYSDATE
                 )
    </insert>

    <insert id="insertDocumentBatch" parameterType="list">
        <foreach collection="list" item="doc" separator=";">
            INSERT INTO DOCUMENTS (
            CATEGORY_ID, TITLE, DESCRIPTION, FILE_PATH, FILE_TYPE,
            ACCESS_TYPE, DOWNLOAD_COUNT, IS_ACTIVE, CREATED_AT
            ) VALUES (
            #{doc.categoryId}, #{doc.title}, #{doc.description}, #{doc.filePath}, #{doc.fileType},
            #{doc.accessType}, #{doc.downloadCount}, #{doc.isActive}, SYSDATE
            )
        </foreach>
    </insert>

    <select id="selectAllDocuments" resultMap="documentResultMap">
        SELECT D.*, C.NAME AS CATEGORY_NAME
        FROM DOCUMENTS D
                 LEFT JOIN DOCUMENT_CATEGORIES C ON D.CATEGORY_ID = C.ID
        ORDER BY D.CREATED_AT DESC
    </select>

    <select id="selectDocumentsByCategory" parameterType="long" resultMap="documentResultMap">
        SELECT D.*, C.NAME AS CATEGORY_NAME
        FROM DOCUMENTS D
                 LEFT JOIN DOCUMENT_CATEGORIES C ON D.CATEGORY_ID = C.ID
        WHERE D.CATEGORY_ID = #{categoryId}
        ORDER BY D.CREATED_AT DESC
    </select>

    <select id="selectDocumentById" parameterType="long" resultMap="documentResultMap">
        SELECT * FROM DOCUMENTS WHERE ID = #{id}
    </select>

    <select id="countDocuments" resultType="int">
        SELECT COUNT(*) FROM DOCUMENTS
    </select>

    <select id="countDocumentsByCategory" parameterType="long" resultType="int">
        SELECT COUNT(*) FROM DOCUMENTS WHERE CATEGORY_ID = #{categoryId}
    </select>

    <delete id="deleteAllDocuments">
        DELETE FROM DOCUMENTS
    </delete>

    <delete id="deleteAllCategories">
        DELETE FROM DOCUMENT_CATEGORIES
    </delete>


    <!-- ===== 기존 팀원 코드 (수정 금지) ===== -->
    <select id="selectDocumentsByUserId" parameterType="string" resultMap="documentResultMap">
        SELECT D.*, C.NAME AS CATEGORY_NAME, H.DOWNLOAD_DATE AS CREATED_AT
        FROM DOCUMENTS D
                 INNER JOIN DOWNLOAD_HISTORY H ON D.ID = H.DOCUMENT_ID
                 LEFT JOIN DOCUMENT_CATEGORIES C ON D.CATEGORY_ID = C.ID
        WHERE H.USER_ID = #{userId}
        ORDER BY H.DOWNLOAD_DATE DESC
    </select>

    <insert id="insertDownloadHistory">
        INSERT INTO DOWNLOAD_HISTORY (
            USER_ID, DOCUMENT_ID, DOWNLOAD_DATE
        ) VALUES (
                     #{userId}, #{documentId}, SYSDATE
                 )
    </insert>

    <select id="selectFilePathById" resultType="string">
        SELECT D.FILE_PATH
        FROM DOCUMENTS D
                 INNER JOIN DOWNLOAD_HISTORY H ON D.ID = H.DOCUMENT_ID
        WHERE D.ID = #{documentId} AND H.USER_ID = #{userId}
    </select>

    <!-- ===== 마이페이지용 추가 쿼리 (DOWNLOAD_DATE 없는 경우 대비) ===== -->
    <!-- DOWNLOAD_HISTORY 테이블의 실제 날짜 컬럼명을 모를 경우 DOCUMENTS.CREATED_AT 기준으로 조회 -->
    <select id="selectDocumentsByUserIdForMypage" parameterType="string" resultMap="documentResultMap">
        SELECT D.*, C.NAME AS CATEGORY_NAME, D.CREATED_AT
        FROM DOCUMENTS D
                 INNER JOIN DOWNLOAD_HISTORY H ON D.ID = H.DOCUMENT_ID
                 LEFT JOIN DOCUMENT_CATEGORIES C ON D.CATEGORY_ID = C.ID
        WHERE H.USER_ID = #{userId}
        ORDER BY D.CREATED_AT DESC
    </select>

</mapper>
